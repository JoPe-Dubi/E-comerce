<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Painel administrativo para adicionar novos produtos ao e-commerce CompreAqui">
    <title>Adicionar Produto - CompreAqui Admin</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-title {
            font-size: 28px;
            color: #1E1E1E;
            margin: 0;
        }

        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background-color 0.3s;
            text-decoration: none;
        }

        .back-btn:hover {
            background-color: #5a6268;
        }

        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #E63946;
            box-shadow: 0 0 0 2px rgba(230, 57, 70, 0.2);
        }

        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .form-group.error .error-message {
            display: block;
        }

        .required-indicator {
            color: #dc3545;
            font-weight: bold;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .image-input {
            margin-bottom: 10px;
        }

        .add-image-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .add-image-btn:hover {
            background-color: #5a6268;
        }

        .remove-image-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .remove-image-btn:hover {
            background-color: #c82333;
        }

        .image-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .image-input-row input {
            flex: 1;
            margin-bottom: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .submit-btn {
            background-color: #E63946;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #d32535;
        }

        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <a href="../index.html" class="logo">
                    <span class="logo-text">Compre<span class="highlight">Aqui</span></span>
                </a>
                <div class="header-right">
                    <a href="../index.html" class="back-to-home">
                        <i class="fas fa-arrow-left"></i> Voltar para a Loja
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="admin-container" role="main">
        <div class="admin-header">
            <h1 class="admin-title">Adicionar Novo Produto</h1>
            <a href="admin-catalog.html" class="back-btn" aria-label="Voltar ao catálogo de produtos">
                <i class="fas fa-arrow-left" aria-hidden="true"></i> Voltar ao Catálogo
            </a>
        </div>

        <div class="form-container">
            <form id="addProductForm" role="form" aria-labelledby="admin-title" novalidate>
                <div class="form-group">
                    <label for="productName">Nome do Produto *</label>
                    <input type="text" id="productName" name="productName" required placeholder="Ex: iPhone 15 Pro">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Valor do Produto (R$) *</label>
                        <input type="number" id="productPrice" name="productPrice" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Categoria *</label>
                        <select id="productCategory" name="productCategory" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="eletronicos">Eletrônicos</option>
                            <option value="eletrodomesticos">Eletrodomésticos</option>
                            <option value="moda">Moda</option>
                            <option value="livros">Livros</option>
                            <option value="games">Games</option>
                            <option value="esportes">Esportes</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productBrand">Marca *</label>
                        <input type="text" id="productBrand" name="productBrand" required placeholder="Ex: Apple">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Estoque</label>
                        <input type="number" id="productStock" name="productStock" min="0" placeholder="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productImageUrl">Adicionar Imagens *</label>
                    <input type="file" id="productImageUrl" name="productImageUrl" accept="image/*" required>
                </div>

                <div class="form-group">
                    <label for="productImages">Imagens Adicionais</label>
                    <div id="imageInputs">
                        <input type="file" class="image-input" accept="image/*">
                        <input type="file" class="image-input" accept="image/*">
                        <input type="file" class="image-input" accept="image/*">
                    </div>
                    <button type="button" id="addImageBtn" class="add-image-btn">
                        <i class="fas fa-plus"></i> Adicionar mais imagens
                    </button>
                </div>

                <div class="form-group">
                    <label for="productDescription">Descrição do Produto *</label>
                    <textarea id="productDescription" name="productDescription" required placeholder="Descreva as características e benefícios do produto..."></textarea>
                </div>

                <div class="form-group">
                    <label for="productLink">Link do Produto</label>
                    <input type="url" id="productLink" name="productLink" placeholder="https://exemplo.com/produto">
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="productOnSale" name="productOnSale">
                        <label for="productOnSale">Produto em Oferta</label>
                    </div>
                </div>

                <div class="form-group" id="originalPriceGroup" style="display: none;">
                    <label for="productOriginalPrice">Preço Original (R$)</label>
                    <input type="number" id="productOriginalPrice" name="productOriginalPrice" step="0.01" min="0" placeholder="0.00">
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-plus"></i> Adicionar Produto
                </button>
            </form>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <span class="logo-text">Compre<span class="highlight">Aqui</span></span>
                    <p>Seu marketplace completo</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Institucional</h3>
                        <ul>
                            <li><a href="#">Sobre nós</a></li>
                            <li><a href="#">Termos de uso</a></li>
                            <li><a href="#">Política de privacidade</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Ajuda</h3>
                        <ul>
                            <li><a href="#">Central de atendimento</a></li>
                            <li><a href="#">Como comprar</a></li>
                            <li><a href="#">Prazos de entrega</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/utils.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Verificar autenticação e permissão de admin
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar autenticação primeiro
            AuthManager.init();
            
            // Aguardar um momento para o AuthState ser carregado
            setTimeout(() => {
                // Verificar se o usuário é administrador
                if (!AuthState.isAuthenticated || !AuthState.user || AuthState.user.role !== 'admin') {
                    window.location.href = '../index.html';
                    return;
                }
                
                // Configurar eventos do formulário
                setupFormEvents();
            }, 100);
        });

        // Configurar eventos do formulário
        function setupFormEvents() {
            const form = document.getElementById('addProductForm');
            const onSaleCheckbox = document.getElementById('productOnSale');
            const originalPriceGroup = document.getElementById('originalPriceGroup');
            const addImageBtn = document.getElementById('addImageBtn');

            // Mostrar/ocultar campo de preço original
            onSaleCheckbox.addEventListener('change', () => {
                if (onSaleCheckbox.checked) {
                    originalPriceGroup.style.display = 'block';
                } else {
                    originalPriceGroup.style.display = 'none';
                    document.getElementById('productOriginalPrice').value = '';
                }
            });

            // Adicionar mais campos de imagem
            addImageBtn.addEventListener('click', () => {
                addImageInput();
            });

            // Submissão do formulário
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handleFormSubmit();
            });
        }

        // Adicionar campo de imagem
        function addImageInput() {
            const imageInputs = document.getElementById('imageInputs');
            const inputCount = imageInputs.querySelectorAll('.image-input, .image-input-row').length;
            
            if (inputCount >= 10) {
                Utils.showNotification('Máximo de 10 imagens permitidas', 'warning');
                return;
            }

            const inputRow = document.createElement('div');
            inputRow.className = 'image-input-row';
            inputRow.innerHTML = `
                <input type="file" class="image-input" accept="image/*">
                <button type="button" class="remove-image-btn" onclick="removeImageInput(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            imageInputs.appendChild(inputRow);
        }

        // Remover campo de imagem
        function removeImageInput(button) {
            button.parentElement.remove();
        }

        // Função para salvar produto no banco de dados
        async function saveProductToDatabase(productData) {
            try {
                const newProduct = {
                    name: productData.name,
                    price: productData.price,
                    originalPrice: productData.originalPrice,
                    images: productData.images,
                    category: productData.category,
                    brand: productData.brand,
                    stock: productData.stock,
                    description: productData.description,
                    link: productData.link,
                    rating: 4.5, // Rating padrão
                    reviews: 0,
                    shortDescription: productData.name,
                    specifications: {
                        'Marca': productData.brand,
                        'Categoria': productData.category,
                        'Estoque': productData.stock + ' unidades'
                    },
                    inStock: productData.stock > 0,
                    featured: productData.featured,
                    discount: productData.originalPrice ? 
                        Math.round(((productData.originalPrice - productData.price) / productData.originalPrice) * 100) : 0,
                    tags: [productData.category, productData.brand.toLowerCase()]
                };
                
                const savedProduct = await productDB.addProduct(newProduct);
                console.log('Produto salvo no banco de dados:', savedProduct);
                return savedProduct;
            } catch (error) {
                console.error('Erro ao salvar produto no banco:', error);
                throw error;
            }
        }
        
        // Função para atualizar a página principal
        function updateMainPageOffers(product) {
            if (!product.featured) return;
            
            // Produto já está salvo no SQLite como featured
            // A página principal carregará automaticamente do banco
            console.log('Produto em oferta salvo no SQLite:', product.name);
        }

        // Processar submissão do formulário
        function handleFormSubmit() {
            const formData = new FormData(document.getElementById('addProductForm'));
            const submitBtn = document.querySelector('.submit-btn');
            
            // Desabilitar botão durante o processamento
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';

            // Coletar todas as imagens
            const mainImageFile = document.getElementById('productImageUrl').files[0];
            const mainImage = mainImageFile ? URL.createObjectURL(mainImageFile) : '';
            
            const additionalImages = [];
            const imageInputs = document.querySelectorAll('.image-input');
            
            imageInputs.forEach(input => {
                if (input.files && input.files[0]) {
                    additionalImages.push(URL.createObjectURL(input.files[0]));
                }
            });

            const allImages = [mainImage, ...additionalImages].filter(img => img);

            // Coletar dados do formulário
            const productData = {
                name: formData.get('productName'),
                price: parseFloat(formData.get('productPrice')),
                category: formData.get('productCategory'),
                brand: formData.get('productBrand'),
                stock: parseInt(formData.get('productStock')) || 0,
                images: allImages,
                description: formData.get('productDescription'),
                link: formData.get('productLink'),
                onSale: formData.get('productOnSale') === 'on',
                originalPrice: formData.get('productOriginalPrice') ? parseFloat(formData.get('productOriginalPrice')) : null,
                featured: formData.get('productOnSale') === 'on' // Produtos em oferta aparecem em destaque
            };

            // Validações
            if (!validateProductData(productData)) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Produto';
                return;
            }

            // Salvar produto no banco de dados
            setTimeout(async () => {
                try {
                    // Salvar produto no banco
                    const savedProduct = await saveProductToDatabase(productData);
                    
                    // Atualizar ofertas se necessário
                    updateMainPageOffers(savedProduct);
                    
                    // Mostrar mensagem de sucesso
                    const successMessage = productData.featured ? 
                        `Produto "${savedProduct.name}" adicionado com sucesso! ID: ${savedProduct.id}. Ele aparecerá na seção "Ofertas Imperdíveis" da página principal.` :
                        `Produto "${savedProduct.name}" adicionado com sucesso! ID: ${savedProduct.id}`;
                    
                    Utils.showNotification(successMessage, 'success');
                    
                    // Resetar formulário
                    document.getElementById('addProductForm').reset();
                    document.getElementById('originalPriceGroup').style.display = 'none';
                    
                    // Limpar campos de imagens adicionais
                    const imageInputs = document.getElementById('imageInputs');
                    const additionalRows = imageInputs.querySelectorAll('.image-input-row');
                    additionalRows.forEach(row => row.remove());
                    
                    // Reabilitar botão
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Produto';
                    
                    // Opcional: redirecionar para a página principal após 4 segundos
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 4000);
                    
                } catch (error) {
                    console.error('Erro ao salvar produto:', error);
                    Utils.showNotification('Erro ao salvar produto no banco de dados. Tente novamente.', 'error');
                    
                    // Reabilitar botão em caso de erro
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Produto';
                }
            }, 1000);
        }

        // Validar dados do produto
        function validateProductData(data) {
            if (!data.name.trim()) {
                Utils.showNotification('Nome do produto é obrigatório', 'error');
                return false;
            }

            if (data.price <= 0) {
                Utils.showNotification('Valor do produto deve ser maior que zero', 'error');
                return false;
            }

            if (!data.category) {
                Utils.showNotification('Categoria é obrigatória', 'error');
                return false;
            }

            if (!data.brand.trim()) {
                Utils.showNotification('Marca é obrigatória', 'error');
                return false;
            }

            if (!data.images || data.images.length === 0 || !data.images[0]) {
                Utils.showNotification('Pelo menos uma imagem é obrigatória', 'error');
                return false;
            }

            if (!data.description.trim()) {
                Utils.showNotification('Descrição é obrigatória', 'error');
                return false;
            }

            if (data.onSale && (!data.originalPrice || data.originalPrice <= data.price)) {
                Utils.showNotification('Preço original deve ser maior que o preço atual para produtos em oferta', 'error');
                return false;
            }

            return true;
        }
    </script>
</body>
</html>